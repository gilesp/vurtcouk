
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">



<meta name="keywords" content="">




<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@gilesp">
<meta name="twitter:title" content="Ubuntu AutoFS Samba/CIFS tweak : vurt.co.uk">
<meta name="twitter:creator" content="@gilesp">
<meta name="twitter:description" content="">

<meta name="twitter:domain" content="vurt.co.uk">


    <base href="http://vurt.co.uk">

    
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="/css/font-awesome.min.css" rel="stylesheet">

    
    
    

    
    <link href="http://fonts.googleapis.com/css?family=Cabin:400,700" rel="stylesheet" type="text/css">

    
    <link href="css/vurt.css" rel="stylesheet">

    <title>Ubuntu AutoFS Samba/CIFS tweak : vurt.co.uk</title>
    <link rel="canonical" href="http://vurt.co.uk/archive/ubuntu-autofs-sambacifs-tweak">
    

  </head>
  <body>
    
<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Vurt.co.uk</a>
    </div>

    
    <div class="collapse navbar-collapse navbar-ex1-collapse">
      <ul class="nav navbar-nav">
        
          <li><a href="/ideas"><span class="fa fa-bolt"></span> Ideas </a></li>
        
          <li><a href="/projects"><span class="fa fa-cogs"></span> Projects </a></li>
        
          <li><a href="http://vurt.co.uk/about"><span class="fa fa-question"></span> About </a></li>
        
      </ul>
    </div>
  </div>
</nav>


    <div class="container">
      <div class="row">
        <div class="col-lg-8">


<h1>Ubuntu AutoFS Samba/CIFS tweak</h1>
<hr>

<p>For a while now I&rsquo;ve been using <a href="http://www.autofs.org/">autofs</a> on my work laptop to automatically mount windows shares when I access them. I achieved this by following <a href="http://www.howtoforge.com/accessing_windows_or_samba_shares_using_autofs">this guide on HowtoForge</a>. Everything runs fine and it means I can do a simpleÂ  <code>ls /cifs/machinename</code> to access all the shares on that particular machine. Provided I&rsquo;d remembered to create a credentials file for that machine name&hellip;</p>

<p>The auto.cifs file shown in the howto requires you to create a credentials file for each machine that you want to access. This is handy when the machines you&rsquo;re accessing have different logins, but here at work all machines authenticate against an Active Directory server and so share the same credentials.</p>

<p>Initially I solved this problem by symlinking to the same credential file, but that&rsquo;s still an inconvenience when you need to access a new machine (and boy, do we have a lot of them). Finally I did the sensible thing and altered the auto.cifs file to fallback to a master credentials file if it can&rsquo;t find a machine specific one. Here&rsquo;s my auto.cifs file:</p>

<pre><code>&lt;code&gt;
#!/bin/bash
# This file must be executable to work! chmod 755!
key=&quot;$1&quot;
# Note: create a cred file for each windows/Samba-Server in your network
#       which requires password authentification.  The file should contain
#       exactly two lines:
#          username=user
#          password=*****
#       Please don't use blank spaces to separate the equal sign from the
#       user account name or password.
credfile=&quot;/etc/auto.smb.$key&quot;
if [ ! -e $credfile ]
then
    credfile=&quot;/etc/auto.smb.master&quot;
fi

# Note: Use cifs instead of smbfs:
mountopts=&quot;-fstype=cifs,file_mode=0644,dir_mode=0755,uid=19654,gid=124&quot;
smbclientopts=&quot;&quot;
for P in /bin /sbin /usr/bin /usr/sbin
do
    if [ -x $P/smbclient ]
        then
                SMBCLIENT=$P/smbclient
                break
        fi
done
[ -x $SMBCLIENT ] || exit 1
if [ -e &quot;$credfile&quot; ]
then
        mountopts=$mountopts&quot;,credentials=$credfile&quot;
        smbclientopts=&quot;-A &quot;$credfile
else
        smbclientopts=&quot;-N&quot;
fi
$SMBCLIENT $smbclientopts -gL $key 2&gt;/dev/null \
   | awk -v key=&quot;$key&quot; -v opts=&quot;$mountopts&quot; -F'|' -- '
        BEGIN   { ORS=&quot;&quot;; first=1 }
    /Disk/  { if (first) { print opts; first=0 };
          gsub(/ /, &quot;\\ &quot;, $2);
               sub(/\$/, &quot;\\$&quot;, $2);
                       print &quot; \\\n\t /&quot; $2, &quot;://&quot; key &quot;/&quot; $2 }
        END     { if (!first) print &quot;\n&quot;; else exit 1 }
        '
&lt;/code&gt;
</code></pre>

<p>The important, and trivial, change is this test:</p>

<pre><code>&lt;code&gt;
if [ ! -e $credfile ]
then
    credfile=&quot;/etc/auto.smb.master&quot;
fi
&lt;/code&gt;
</code></pre>

<p>All it does is check for the existence of the credfile. If it can&rsquo;t find it, it uses /etc/auto/smb/master instead.</p>

<p>The beauty of this is that I can use one credentials file for the majority of the file shares yet still provide different credentials for the one or two servers I need to access as a different user (such as an admin user).</p>

<hr>

</div>
<div class="col-lg-4">
  <div id="toc" class="well">
    <section id="info">
      <p><span class="glyphicon glyphicon-time"></span> Posted on Thu 25 Feb, 2010</p>
    </section>
    <section id="social">
  <h4><span class="fa fa-share-alt"> </span> Share</h4>
  <ul class="social">
    <li> <a href="https://twitter.com/intent/tweet?status=Ubuntu%20AutoFS%20Samba%2fCIFS%20tweak-http%3a%2f%2fvurt.co.uk%2farchive%2fubuntu-autofs-sambacifs-tweak" target="_blank" title="Tweet this" class="twitter"><span class="fa fa-twitter-square fa-fw"></span>Twitter</a> </li>
    <li> <a href="https://www.facebook.com/sharer/sharer.php?u=http%3a%2f%2fvurt.co.uk%2farchive%2fubuntu-autofs-sambacifs-tweak" target="_blank" title="Share this on Facebook" class="facebook"><span class="fa fa-facebook-square fa-fw"></span>Facebook</a> </li>
    <li> <a href="https://plus.google.com/share?url=http%3a%2f%2fvurt.co.uk%2farchive%2fubuntu-autofs-sambacifs-tweak" target="_blank" title="Google+" class="googleplus"><span class="fa fa-google-plus-square fa-fw"></span>Google+</a> </li>
    <li> <a href="http://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fvurt.co.uk%2farchive%2fubuntu-autofs-sambacifs-tweak&title=Ubuntu%20AutoFS%20Samba%2fCIFS%20tweak&source=vurt.co.uk" target="_blank" title="LinkedIn" class="linkedin"><span class="fa fa-linkedin-square fa-fw"></span>LinkedIn</a> </li>
    <li> <a href="http://www.reddit.com/submit?url=http%3a%2f%2fvurt.co.uk%2farchive%2fubuntu-autofs-sambacifs-tweak" target="_blank" title="Reddit" class="reddit"><span class="fa fa-reddit-square fa-fw"></span>Reddit</a> </li>
  </ul>

</section>

        <section id="next">
      <a class="next" href="http://vurt.co.uk/archive/the-oracle-sun-merger"><i class="glyphicon glyphicon-chevron-left"></i> The Oracle/Sun Merger</a>
    </section>
    <section id="prev">
      <a class="previous" href="http://vurt.co.uk/archive/ubuntu-lucid-10-04-active-directory-woes"><i class="glyphicon glyphicon-chevron-right"></i> Ubuntu Lucid 10.04 Active Directory Woes</a><br>
    </section>

    
  </div>

    </div>
  </div>

  <hr>

  <footer>
    <div class="row">
      <div class="col-lg-12">
        <p>Copyright &copy; Giles Paterson</p>
      </div>
    </div>
  </footer>
</div>

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-52057933-1', 'vurt.co.uk');
  ga('send', 'pageview');

  </script>
  <script src="/js/jquery-2.1.1.min.js"></script>
  <script src="/js/bootstrap.min.js"></script>
  </body>
</html>

